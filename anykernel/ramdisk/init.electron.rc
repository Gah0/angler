# Start Electron changes
# Many of these tweaks are thanks to AK, Franco, and Nathan Chancellor. 

on property:sys.boot_completed=1
    # Re-enable retention idle state
    write /sys/module/lpm_levels/system/a53/cpu0/retention/idle_enabled 1
    write /sys/module/lpm_levels/system/a53/cpu1/retention/idle_enabled 1
    write /sys/module/lpm_levels/system/a53/cpu2/retention/idle_enabled 1
    write /sys/module/lpm_levels/system/a53/cpu3/retention/idle_enabled 1
    write /sys/module/lpm_levels/system/a57/cpu4/retention/idle_enabled 1
    write /sys/module/lpm_levels/system/a57/cpu5/retention/idle_enabled 1
    write /sys/module/lpm_levels/system/a53/a53-l2-retention/idle_enabled 1
    write /sys/module/lpm_levels/system/a57/a57-l2-retention/idle_enabled 1

    # Process Reclain
    write /sys/module/process_reclaim/parameters/enable_process_reclaim 1
    write /sys/module/process_reclaim/parameters/pressure_min 50
    write /sys/module/process_reclaim/parameters/pressure_max 70
    write /sys/module/process_reclaim/parameters/per_swap_size 512
    write /sys/module/process_reclaim/parameters/swap_opt_eff 30

    # Disable some Wlan wakelocks
    write /sys/module/wakeup/parameters/enable_wlan_rx_wake_ws 0
    write /sys/module/wakeup/parameters/enable_wlan_ctrl_wake_ws 0
    write /sys/module/wakeup/parameters/enable_wlan_wake_ws 0

    # Start Power tweaks
    exec u:r:init:s0 root root -- /init.special_power.sh

    # Initialize frequency hardlimits
    chown system system /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq_hardlimit
    chmod 0664 /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq_hardlimit
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq_hardlimit 302400
    chown system system /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq_hardlimit
    chmod 0664 /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq_hardlimit
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq_hardlimit 1708000
    chown system system /sys/devices/system/cpu/cpu4/cpufreq/scaling_min_freq_hardlimit
    chmod 0664 /sys/devices/system/cpu/cpu4/cpufreq/scaling_min_freq_hardlimit
    write /sys/devices/system/cpu/cpu4/cpufreq/scaling_min_freq_hardlimit 633600
    chown system system /sys/devices/system/cpu/cpu4/cpufreq/scaling_max_freq_hardlimit
    chmod 0664 /sys/devices/system/cpu/cpu4/cpufreq/scaling_max_freq_hardlimit
    write /sys/devices/system/cpu/cpu4/cpufreq/scaling_max_freq_hardlimit 1958400

    # Tune Chill: Allow for rapid freq increases on LITTLE to require less use of big cores
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_governor chill
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_min_freq 302400
    write /sys/devices/system/cpu/cpu0/cpufreq/scaling_max_freq 1708000
    write /sys/devices/system/cpu/cpu4/cpufreq/scaling_governor chill
    write /sys/devices/system/cpu/cpu4/cpufreq/scaling_min_freq 633600
    write /sys/devices/system/cpu/cpu4/cpufreq/scaling_max_freq 1958400
    write /sys/module/cpu_boost/parameters/input_boost_enabled 1
    write /sys/module/cpu_boost/parameters/input_boost_freq 0:960000 1:672000 2:0 3:0 4:0 5:0 6:0 7:0
    write /sys/module/cpu_boost/parameters/boost_ms 0
    write /sys/module/cpu_boost/parameters/input_boost_ms 40
    write /sys/module/msm_performance/parameters/touchboost 0
    chown system system /sys/devices/system/cpu/cpu0/cpufreq/chill/boost_count
    chmod 0644 /sys/devices/system/cpu/cpu0/cpufreq/chill/boost_count
    write /sys/devices/system/cpu/cpu0/cpufreq/chill/boost_count 5
    chown system system /sys/devices/system/cpu/cpu4/cpufreq/chill/boost_count
    chmod 0644 /sys/devices/system/cpu/cpu4/cpufreq/chill/boost_count
    write /sys/devices/system/cpu/cpu4/cpufreq/chill/boost_count 10
    chown system system /sys/devices/system/cpu/cpu0/cpufreq/chill/freq_step
    chmod 0644 /sys/devices/system/cpu/cpu0/cpufreq/chill/freq_step
    write /sys/devices/system/cpu/cpu0/cpufreq/chill/freq_step 6
    chown system system /sys/devices/system/cpu/cpu4/cpufreq/chill/freq_step
    chmod 0644 /sys/devices/system/cpu/cpu4/cpufreq/chill/freq_step
    write /sys/devices/system/cpu/cpu4/cpufreq/chill/freq_step 4
    chown system system /sys/devices/system/cpu/cpu4/cpufreq/chill/down_threshold
    chmod 0644 /sys/devices/system/cpu/cpu4/cpufreq/chill/down_threshold
    write /sys/devices/system/cpu/cpu4/cpufreq/chill/down_threshold 50
    chown system system /sys/devices/system/cpu/cpu4/cpufreq/chill/down_threshold_suspended
    chmod 0644 /sys/devices/system/cpu/cpu4/cpufreq/chill/down_threshold_suspened
    write /sys/devices/system/cpu/cpu4/cpufreq/chill/down_threshold_suspended 70 
    chown system system /sys/devices/system/cpu/cpu0/cpufreq/chill/up_threshold
    chmod 0644 /sys/devices/system/cpu/cpu0/cpufreq/chill/up_threshold
    write /sys/devices/system/cpu/cpu0/cpufreq/chill/up_threshold 70
    chown system system /sys/devices/system/cpu/cpu4/cpufreq/chill/up_threshold
    chmod 0644 /sys/devices/system/cpu/cpu4/cpufreq/chill/up_threshold
    write /sys/devices/system/cpu/cpu4/cpufreq/chill/up_threshold 90

    # Set I/O Scheduler tweaks
    write /sys/block/mmcblk0/queue/scheduler maple
    write /sys/block/mmcblk0/queue/read_ahead_kb 512
    write /sys/block/mmcblk0/queue/iosched/writes_starved 4
    write /sys/block/mmcblk0/queue/iosched/fifo_batch 16
    write /sys/block/mmcblk0/queue/iosched/sync_read_expire 350
    write /sys/block/mmcblk0/queue/iosched/sync_write_expire 550
    write /sys/block/mmcblk0/queue/iosched/async_read_expire 250
    write /sys/block/mmcblk0/queue/iosched/async_write_expire 450
    write /sys/block/mmcblk0/queue/iosched/sleep_latency_multiple 10

    # Set UKSM configuration
    write /sys/kernel/mm/uksm/max_cpu_percentage 20
    write /sys/kernel/mm/uksm/run 1

    # Set cpuset background CPUs
    write /dev/cpuset/background/cpus 0-2
   
    # Enable ZSwap
    write /sys/module/zswap/parameters/enabled Y
    
    # Set Swappiness
    write /proc/sys/vm/swappiness 8

    # Enable Laptop Mode
    write /proc/sys/vm/laptop_mode 1
